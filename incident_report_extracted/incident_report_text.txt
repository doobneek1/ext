Summary
tl;dr, we have three problems that need to be addressed in our prod deployment of streetlives-api, in this order of priority:
1. Database connection starvation
2. Invocations spiking (maybe due to spam traffic)
3. Lambda connections throttling
As a temporary solution, I am going to reduce the reserved concurrency on the lambda prod function from 25 to 20.
Please see a detailed incident report below.
Description
Today, we saw a spike in server errors. This happened because we were running out of database connections. This is definitive. Please see screenshots attached. The pattern of spikes in this particular error message exactly matches the spikes in the connection utilization.
Error messages:
Connection utilization (middle-right graph):
Error message detail indicating starvation in number of available database connections:
Current Configuration of streetlives-api prod lambda function
Currently, I have the lambda configured as follows:
reserved concurrency: 25
max connections in the pool: 3
RDS Proxy is currently DISABLED (because it was making it difficult to diagnose the root cause of high database load, and for other reasons I will describe below)
For a maximum connection utilization of 75 (25 * 3).
This is probably set a bit too high. It doesn't like when you are using ~75 connections. It wants you to use fewer connections. Maybe ~60 would be a safe number.
Additionally, by setting the reserved concurrency to 25, it means that the lambda is occasionally throttling, which is not ideal. See screenshot (see where Throttles increase, and Concurrent Executions max out at 25):
Unknowns
One unknown is why we have these spikes in invocations. It’s hard to explain this solely based on organic traffic, so maybe it’s due to spam traffic. 
Proposed Solutions
3 possible solutions:
1. Reduce reserved concurrency from 25 to 20
This will probably be a simple solution to address connection starvation, but will exacerbate lambda connection throttling problem somewhat.
2. Restore RDS Proxy
I turned off RDS Proxy in prod because we had a separate problem of database load that needed to be diagnosed, and introducing a proxy was making diagnostics more complicated for this issue. See screenshots below.
History high database load (714% before optimizing slow query on metadatatable):
Current database load (20.3% after optimizing slow query on metadata table):
Also, there are some issues in our code that are causing high Session Pinning, which means that database connections are unable to be reused in RDS Proxy in an optimal way. I addressed some of these, but was unable to fix one final one, described below. So I'm not confident that we would fully benefit from RDS Proxy, and it could continue to make diagnostics more complicated.
Historic high Session-pinned connections:
I don’t have a screenshot, but the last session-pinned connection error I was getting was: 2025-12-31T16:16:05.623Z [WARN] [proxyEndpoint=default] [clientConnection=935748166] The client session was pinned to the database connection [dbConnection=194289819] for the remainder of the session. The proxy can't reuse this connection until the session ends. Reason: The connection ran a SQL query which exceeded the 16384 byte limit.
I didn’t track down which SQL query was exceeding this byte limit that was causing the connection to be pinned.
3. Implement AWS WAF on API Gateway, or Cloudflare, to protect against spam traffic
This might help reduce spam traffic, and reduce the issues we are seeing related to invocations spiking. Although we have not definitively proven the cause of the spike in lambda invocations, it is difficult to explain based solely on organic traffic, and so this might help to “immunize” us from this risk.
Additional Anomaly
Costs are unusually high this month. This needs to be investigated soon:
Example of 16KB+ SQL query
SELECT "Location"."id", "Location"."name", "Location"."description", "Location"."transportation", "Location"."position", "Location"."additional_info", "Location"."slug", "Location"."last_validated_at", "Location"."name_vector", "Location"."streetview_url", "Location"."created_at" AS "createdAt", "Location"."updated_at" AS "updatedAt", "Location"."organization_id", (
           SELECT neighborhood
           FROM nyc_neighborhood_geometries
           WHERE ST_Contains(
             nyc_neighborhood_geometries.geometry,
             ST_SetSRID(position,4326)
           )
       ) AS "neighborhood", "Services"."id" AS "Services.id", "Services"."name" AS "Services.name", "Services"."description" AS "Services.description", "Services"."url" AS "Services.url", "Services"."email" AS "Services.email", "Services"."interpretation_services" AS "Services.interpretation_services", "Services"."fees" AS "Services.fees", "Services"."additional_info" AS "Services.additional_info", "Services"."name_vector" AS "Services.name_vector", "Services"."description_vector" AS "Services.description_vector", "Services"."created_at" AS "Services.createdAt", "Services"."updated_at" AS "Services.updatedAt", "Services"."organization_id" AS "Services.organization_id", "Services->ServiceAtLocation"."id" AS "Services.ServiceAtLocation.id", "Services->ServiceAtLocation"."description" AS "Services.ServiceAtLocation.description", "Services->ServiceAtLocation"."created_at" AS "Services.ServiceAtLocation.createdAt", "Services->ServiceAtLocation"."updated_at" AS "Services.ServiceAtLocation.updatedAt", "Services->ServiceAtLocation"."location_id" AS "Services.ServiceAtLocation.location_id", "Services->ServiceAtLocation"."service_id" AS "Services.ServiceAtLocation.service_id", "Services->Eligibilities"."id" AS "Services.Eligibilities.id", "Services->Eligibilities"."eligible_values" AS "Services.Eligibilities.eligible_values", "Services->Eligibilities"."description" AS "Services.Eligibilities.description", "Services->Eligibilities"."created_at" AS "Services.Eligibilities.createdAt", "Services->Eligibilities"."updated_at" AS "Services.Eligibilities.updatedAt", "Services->Eligibilities"."parameter_id" AS "Services.Eligibilities.parameter_id", "Services->Eligibilities"."service_id" AS "Services.Eligibilities.service_id", "Services->Eligibilities->EligibilityParameter"."id" AS "Services.Eligibilities.EligibilityParameter.id", "Services->Eligibilities->EligibilityParameter"."name" AS "Services.Eligibilities.EligibilityParameter.name", "Services->Eligibilities->EligibilityParameter"."created_at" AS "Services.Eligibilities.EligibilityParameter.createdAt", "Services->Eligibilities->EligibilityParameter"."updated_at" AS "Services.Eligibilities.EligibilityParameter.updatedAt", "Services->ServiceTaxonomySpecificAttributes"."id" AS "Services.ServiceTaxonomySpecificAttributes.id", "Services->ServiceTaxonomySpecificAttributes"."values" AS "Services.ServiceTaxonomySpecificAttributes.values", "Services->ServiceTaxonomySpecificAttributes"."created_at" AS "Services.ServiceTaxonomySpecificAttributes.createdAt", "Services->ServiceTaxonomySpecificAttributes"."updated_at" AS "Services.ServiceTaxonomySpecificAttributes.updatedAt", "Services->ServiceTaxonomySpecificAttributes"."attribute_id" AS "Services.ServiceTaxonomySpecificAttributes.attribute_id", "Services->ServiceTaxonomySpecificAttributes"."service_id" AS "Services.ServiceTaxonomySpecificAttributes.service_id", "Services->ServiceTaxonomySpecificAttributes->attribute"."id" AS "Services.ServiceTaxonomySpecificAttributes.attribute.id", "Services->ServiceTaxonomySpecificAttributes->attribute"."name" AS "Services.ServiceTaxonomySpecificAttributes.attribute.name", "Services->ServiceTaxonomySpecificAttributes->attribute"."created_at" AS "Services.ServiceTaxonomySpecificAttributes.attribute.createdAt", "Services->ServiceTaxonomySpecificAttributes->attribute"."updated_at" AS "Services.ServiceTaxonomySpecificAttributes.attribute.updatedAt", "Services->ServiceTaxonomySpecificAttributes->attribute"."taxonomy_id" AS "Services.ServiceTaxonomySpecificAttributes.attribute.TaxonomyId", "Services->Taxonomies"."id" AS "Services.Taxonomies.id", "Services->Taxonomies"."name" AS "Services.Taxonomies.name", "Services->Taxonomies"."parent_name" AS "Services.Taxonomies.parent_name", "Services->Taxonomies"."name_vector" AS "Services.Taxonomies.name_vector", "Services->Taxonomies"."created_at" AS "Services.Taxonomies.createdAt", "Services->Taxonomies"."updated_at" AS "Services.Taxonomies.updatedAt", "Services->Taxonomies"."parent_id" AS "Services.Taxonomies.parent_id", "Services->Taxonomies->ServiceTaxonomy"."id" AS "Services.Taxonomies.ServiceTaxonomy.id", "Services->Taxonomies->ServiceTaxonomy"."created_at" AS "Services.Taxonomies.ServiceTaxonomy.createdAt", "Services->Taxonomies->ServiceTaxonomy"."updated_at" AS "Services.Taxonomies.ServiceTaxonomy.updatedAt", "Services->Taxonomies->ServiceTaxonomy"."service_id" AS "Services.Taxonomies.ServiceTaxonomy.service_id", "Services->Taxonomies->ServiceTaxonomy"."taxonomy_id" AS "Services.Taxonomies.ServiceTaxonomy.taxonomy_id", "Services->RegularSchedules"."id" AS "Services.RegularSchedules.id", "Services->RegularSchedules"."weekday" AS "Services.RegularSchedules.weekday", "Services->RegularSchedules"."opens_at" AS "Services.RegularSchedules.opens_at", "Services->RegularSchedules"."closes_at" AS "Services.RegularSchedules.closes_at", "Services->RegularSchedules"."created_at" AS "Services.RegularSchedules.createdAt", "Services->RegularSchedules"."updated_at" AS "Services.RegularSchedules.updatedAt", "Services->RegularSchedules"."location_id" AS "Services.RegularSchedules.location_id", "Services->RegularSchedules"."service_id" AS "Services.RegularSchedules.service_id", "Services->RegularSchedules"."service_at_location_id" AS "Services.RegularSchedules.service_at_location_id", "Services->HolidaySchedules"."id" AS "Services.HolidaySchedules.id", "Services->HolidaySchedules"."closed" AS "Services.HolidaySchedules.closed", "Services->HolidaySchedules"."opens_at" AS "Services.HolidaySchedules.opens_at", "Services->HolidaySchedules"."closes_at" AS "Services.HolidaySchedules.closes_at", "Services->HolidaySchedules"."start_date" AS "Services.HolidaySchedules.start_date", "Services->HolidaySchedules"."end_date" AS "Services.HolidaySchedules.end_date", "Services->HolidaySchedules"."weekday" AS "Services.HolidaySchedules.weekday", "Services->HolidaySchedules"."occasion" AS "Services.HolidaySchedules.occasion", "Services->HolidaySchedules"."created_at" AS "Services.HolidaySchedules.createdAt", "Services->HolidaySchedules"."updated_at" AS "Services.HolidaySchedules.updatedAt", "Services->HolidaySchedules"."location_id" AS "Services.HolidaySchedules.location_id", "Services->HolidaySchedules"."service_id" AS "Services.HolidaySchedules.service_id", "Services->HolidaySchedules"."service_at_location_id" AS "Services.HolidaySchedules.service_at_location_id", "Services->Languages"."id" AS "Services.Languages.id", "Services->Languages"."language" AS "Services.Languages.language", "Services->Languages"."name" AS "Services.Languages.name", "Services->Languages"."created_at" AS "Services.Languages.createdAt", "Services->Languages"."updated_at" AS "Services.Languages.updatedAt", "Services->Languages->ServiceLanguages"."id" AS "Services.Languages.ServiceLanguages.id", "Services->Languages->ServiceLanguages"."created_at" AS "Services.Languages.ServiceLanguages.createdAt", "Services->Languages->ServiceLanguages"."updated_at" AS "Services.Languages.ServiceLanguages.updatedAt", "Services->Languages->ServiceLanguages"."language_id" AS "Services.Languages.ServiceLanguages.language_id", "Services->Languages->ServiceLanguages"."service_id" AS "Services.Languages.ServiceLanguages.service_id", "Services->RequiredDocuments"."id" AS "Services.RequiredDocuments.id", "Services->RequiredDocuments"."document" AS "Services.RequiredDocuments.document", "Services->RequiredDocuments"."created_at" AS "Services.RequiredDocuments.createdAt", "Services->RequiredDocuments"."updated_at" AS "Services.RequiredDocuments.updatedAt", "Services->RequiredDocuments"."service_id" AS "Services.RequiredDocuments.service_id", "Services->DocumentsInfo"."id" AS "Services.DocumentsInfo.id", "Services->DocumentsInfo"."recertification_time" AS "Services.DocumentsInfo.recertification_time", "Services->DocumentsInfo"."grace_period" AS "Services.DocumentsInfo.grace_period", "Services->DocumentsInfo"."additional_info" AS "Services.DocumentsInfo.additional_info", "Services->DocumentsInfo"."created_at" AS "Services.DocumentsInfo.createdAt", "Services->DocumentsInfo"."updated_at" AS "Services.DocumentsInfo.updatedAt", "Services->DocumentsInfo"."service_id" AS "Services.DocumentsInfo.service_id", "Services->Phones"."id" AS "Services.Phones.id", "Services->Phones"."number" AS "Services.Phones.number", "Services->Phones"."extension" AS "Services.Phones.extension", "Services->Phones"."type" AS "Services.Phones.type", "Services->Phones"."language" AS "Services.Phones.language", "Services->Phones"."description" AS "Services.Phones.description", "Services->Phones"."created_at" AS "Services.Phones.createdAt", "Services->Phones"."updated_at" AS "Services.Phones.updatedAt", "Services->Phones"."location_id" AS "Services.Phones.location_id", "Services->Phones"."organization_id" AS "Services.Phones.organization_id", "Services->Phones"."service_id" AS "Services.Phones.service_id", "Services->Phones"."service_at_location_id" AS "Services.Phones.service_at_location_id", "Services->EventRelatedInfos"."id" AS "Services.EventRelatedInfos.id", "Services->EventRelatedInfos"."event" AS "Services.EventRelatedInfos.event", "Services->EventRelatedInfos"."information" AS "Services.EventRelatedInfos.information", "Services->EventRelatedInfos"."created_at" AS "Services.EventRelatedInfos.createdAt", "Services->EventRelatedInfos"."updated_at" AS "Services.EventRelatedInfos.updatedAt", "Services->EventRelatedInfos"."location_id" AS "Services.EventRelatedInfos.location_id", "Services->EventRelatedInfos"."service_id" AS "Services.EventRelatedInfos.service_id", "Services->ServiceAreas"."id" AS "Services.ServiceAreas.id", "Services->ServiceAreas"."postal_codes" AS "Services.ServiceAreas.postal_codes", "Services->ServiceAreas"."description" AS "Services.ServiceAreas.description", "Services->ServiceAreas"."created_at" AS "Services.ServiceAreas.createdAt", "Services->ServiceAreas"."updated_at" AS "Services.ServiceAreas.updatedAt", "Services->ServiceAreas"."service_id" AS "Services.ServiceAreas.service_id", "Organization"."id" AS "Organization.id", "Organization"."name" AS "Organization.name", "Organization"."description" AS "Organization.description", "Organization"."email" AS "Organization.email", "Organization"."url" AS "Organization.url", "Organization"."partners" AS "Organization.partners", "Organization"."name_vector" AS "Organization.name_vector", "Organization"."created_at" AS "Organization.createdAt", "Organization"."updated_at" AS "Organization.updatedAt", "Organization->Phones"."id" AS "Organization.Phones.id", "Organization->Phones"."number" AS "Organization.Phones.number", "Organization->Phones"."extension" AS "Organization.Phones.extension", "Organization->Phones"."type" AS "Organization.Phones.type", "Organization->Phones"."language" AS "Organization.Phones.language", "Organization->Phones"."description" AS "Organization.Phones.description", "Organization->Phones"."created_at" AS "Organization.Phones.createdAt", "Organization->Phones"."updated_at" AS "Organization.Phones.updatedAt", "Organization->Phones"."location_id" AS "Organization.Phones.location_id", "Organization->Phones"."organization_id" AS "Organization.Phones.organization_id", "Organization->Phones"."service_id" AS "Organization.Phones.service_id", "Organization->Phones"."service_at_location_id" AS "Organization.Phones.service_at_location_id", "Phones"."id" AS "Phones.id", "Phones"."number" AS "Phones.number", "Phones"."extension" AS "Phones.extension", "Phones"."type" AS "Phones.type", "Phones"."language" AS "Phones.language", "Phones"."description" AS "Phones.description", "Phones"."created_at" AS "Phones.createdAt", "Phones"."updated_at" AS "Phones.updatedAt", "Phones"."location_id" AS "Phones.location_id", "Phones"."organization_id" AS "Phones.organization_id", "Phones"."service_id" AS "Phones.service_id", "Phones"."service_at_location_id" AS "Phones.service_at_location_id", "PhysicalAddresses"."id" AS "PhysicalAddresses.id", "PhysicalAddresses"."address_1" AS "PhysicalAddresses.address_1", "PhysicalAddresses"."city" AS "PhysicalAddresses.city", "PhysicalAddresses"."region" AS "PhysicalAddresses.region", "PhysicalAddresses"."state_province" AS "PhysicalAddresses.state_province", "PhysicalAddresses"."postal_code" AS "PhysicalAddresses.postal_code", "PhysicalAddresses"."country" AS "PhysicalAddresses.country", "PhysicalAddresses"."created_at" AS "PhysicalAddresses.createdAt", "PhysicalAddresses"."updated_at" AS "PhysicalAddresses.updatedAt", "PhysicalAddresses"."location_suggestion_id" AS "PhysicalAddresses.location_suggestion_id", "PhysicalAddresses"."location_id" AS "PhysicalAddresses.location_id", "AccessibilityForDisabilities"."id" AS "AccessibilityForDisabilities.id", "AccessibilityForDisabilities"."accessibility" AS "AccessibilityForDisabilities.accessibility", "AccessibilityForDisabilities"."details" AS "AccessibilityForDisabilities.details", "AccessibilityForDisabilities"."created_at" AS "AccessibilityForDisabilities.createdAt", "AccessibilityForDisabilities"."updated_at" AS "AccessibilityForDisabilities.updatedAt", "AccessibilityForDisabilities"."location_id" AS "AccessibilityForDisabilities.location_id", "EventRelatedInfos"."id" AS "EventRelatedInfos.id", "EventRelatedInfos"."event" AS "EventRelatedInfos.event", "EventRelatedInfos"."information" AS "EventRelatedInfos.information", "EventRelatedInfos"."created_at" AS "EventRelatedInfos.createdAt", "EventRelatedInfos"."updated_at" AS "EventRelatedInfos.updatedAt", "EventRelatedInfos"."location_id" AS "EventRelatedInfos.location_id", "EventRelatedInfos"."service_id" AS "EventRelatedInfos.service_id" FROM "locations" AS "Location" LEFT OUTER JOIN ( "service_at_locations" AS "Services->ServiceAtLocation" INNER JOIN "services" AS "Services" ON "Services"."id" = "Services->ServiceAtLocation"."service_id") ON "Location"."id" = "Services->ServiceAtLocation"."location_id" LEFT OUTER JOIN "eligibility" AS "Services->Eligibilities" ON "Services"."id" = "Services->Eligibilities"."service_id" LEFT OUTER JOIN "eligibility_parameters" AS "Services->Eligibilities->EligibilityParameter" ON "Services->Eligibilities"."parameter_id" = "Services->Eligibilities->EligibilityParameter"."id" LEFT OUTER JOIN "service_taxonomy_specific_attributes" AS "Services->ServiceTaxonomySpecificAttributes" ON "Services"."id" = "Services->ServiceTaxonomySpecificAttributes"."service_id" LEFT OUTER JOIN "taxonomy_specific_attributes" AS "Services->ServiceTaxonomySpecificAttributes->attribute" ON "Services->ServiceTaxonomySpecificAttributes"."attribute_id" = "Services->ServiceTaxonomySpecificAttributes->attribute"."id" LEFT OUTER JOIN ( "service_taxonomy" AS "Services->Taxonomies->ServiceTaxonomy" INNER JOIN "taxonomies" AS "Services->Taxonomies" ON "Services->Taxonomies"."id" = "Services->Taxonomies->ServiceTaxonomy"."taxonomy_id") ON "Services"."id" = "Services->Taxonomies->ServiceTaxonomy"."service_id" LEFT OUTER JOIN "regular_schedules" AS "Services->RegularSchedules" ON "Services"."id" = "Services->RegularSchedules"."service_id" LEFT OUTER JOIN "holiday_schedules" AS "Services->HolidaySchedules" ON "Services"."id" = "Services->HolidaySchedules"."service_id" LEFT OUTER JOIN ( "service_languages" AS "Services->Languages->ServiceLanguages" INNER JOIN "languages" AS "Services->Languages" ON "Services->Languages"."id" = "Services->Languages->ServiceLanguages"."language_id") ON "Services"."id" = "Services->Languages->ServiceLanguages"."service_id" LEFT OUTER JOIN "required_documents" AS "Services->RequiredDocuments" ON "Services"."id" = "Services->RequiredDocuments"."service_id" LEFT OUTER JOIN "documents_infos" AS "Services->DocumentsInfo" ON "Services"."id" = "Services->DocumentsInfo"."service_id" LEFT OUTER JOIN "phones" AS "Services->Phones" ON "Services"."id" = "Services->Phones"."service_id" LEFT OUTER JOIN "event_related_info" AS "Services->EventRelatedInfos" ON "Services"."id" = "Services->EventRelatedInfos"."service_id" LEFT OUTER JOIN "service_areas" AS "Services->ServiceAreas" ON "Services"."id" = "Services->ServiceAreas"."service_id" LEFT OUTER JOIN "organizations" AS "Organization" ON "Location"."organization_id" = "Organization"."id" LEFT OUTER JOIN "phones" AS "Organization->Phones" ON "Organization"."id" = "Organization->Phones"."organization_id" LEFT OUTER JOIN "phones" AS "Phones" ON "Location"."id" = "Phones"."location_id" LEFT OUTER JOIN "physical_addresses" AS "PhysicalAddresses" ON "Location"."id" = "PhysicalAddresses"."location_id" LEFT OUTER JOIN "accessibility_for_disabilities" AS "AccessibilityForDisabilities" ON "Location"."id" = "AccessibilityForDisabilities"."location_id" LEFT OUTER JOIN "event_related_info" AS "EventRelatedInfos" ON "Location"."id" = "EventRelatedInfos"."location_id" WHERE "Location"."id" = '076ae17e-189e-463a-a65d-c181c92ac8c1';